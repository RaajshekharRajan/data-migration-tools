<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise CSV to SQL Converter</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>

    <style>
        /* --- ENTERPRISE THEME VARIABLES --- */
        :root {
            --c-bg: #f8fafc;          /* Slate 50 */
            --c-surface: #ffffff;     /* White */
            --c-text-main: #0f172a;   /* Slate 900 */
            --c-text-muted: #64748b;  /* Slate 500 */
            --c-border: #e2e8f0;      /* Slate 200 */
            --c-primary: #0f172a;     /* Slate 900 */
            --c-primary-hover: #1e293b;
            --c-accent: #3b82f6;      /* Blue 500 */
            --c-success-bg: #f0fdf4;
            --c-success-text: #15803d;
            --c-warning-bg: #fffbeb;
            --c-warning-text: #92400e;
            --c-warning-border: #fcd34d;
            
            --font-ui: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
            --radius: 12px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--c-bg);
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 24px 24px;
            font-family: var(--font-ui);
            color: var(--c-text-main);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        .app-header {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--c-border);
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 0 24px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            font-size: 18px;
            letter-spacing: -0.02em;
        }
        
        .brand-icon {
            background: linear-gradient(135deg, #0f172a, #334155);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 14px;
        }

        .refresh-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            font-weight: 600;
            color: var(--c-text-muted);
            background: transparent;
            border: 1px solid var(--c-border);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .refresh-btn:hover { background: white; color: var(--c-text-main); border-color: var(--c-text-muted); }

        /* --- MAIN CONTENT --- */
        .main-content {
            max-width: 1000px;
            margin: 40px auto;
            width: 100%;
            padding: 0 20px;
            flex: 1;
            padding-bottom: 80px;
        }

        /* --- CARDS (Steps) --- */
        .step-card {
            background: var(--c-surface);
            border: 1px solid var(--c-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 32px;
            margin-bottom: 24px;
            transition: all 0.3s ease;
            opacity: 0.5;
            pointer-events: none;
            filter: grayscale(100%);
        }
        
        .step-card.active {
            opacity: 1;
            pointer-events: auto;
            box-shadow: var(--shadow-md);
            border-color: #cbd5e1;
            filter: grayscale(0%);
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--c-border);
        }

        .step-badge {
            background: #f1f5f9;
            color: var(--c-text-muted);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            padding: 4px 10px;
            border-radius: 20px;
            letter-spacing: 0.05em;
        }
        .step-card.active .step-badge { background: #e0f2fe; color: #0284c7; }

        .step-title { font-size: 18px; font-weight: 700; margin: 0; }

        /* --- FORM ELEMENTS --- */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--c-text-muted);
            margin-bottom: 8px;
            letter-spacing: 0.03em;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--c-border);
            border-radius: 8px;
            font-size: 14px;
            font-family: var(--font-ui);
            background: white;
            transition: border 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--c-accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* --- UPLOAD ZONE --- */
        .upload-zone {
            border: 2px dashed var(--c-border);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.2s;
        }
        .upload-zone:hover, .upload-zone.drag-active {
            border-color: var(--c-accent);
            background: #eff6ff;
        }
        .upload-icon { color: var(--c-text-muted); margin-bottom: 12px; }
        .upload-text { font-weight: 600; font-size: 16px; color: var(--c-text-main); }
        .upload-sub { font-size: 13px; color: var(--c-text-muted); margin-top: 4px; }

        /* --- DATA MAPPER TABLE --- */
        .mapper-container {
            border: 1px solid var(--c-border);
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 24px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        table { width: 100%; border-collapse: collapse; }
        
        thead { background: #f8fafc; border-bottom: 1px solid var(--c-border); position: sticky; top: 0; z-index: 10; }
        
        th {
            text-align: left;
            padding: 12px 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--c-text-muted);
        }
        
        td {
            padding: 10px 16px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
            vertical-align: middle;
            background: white;
        }
        tr:last-child td { border-bottom: none; }
        
        .preview-cell {
            font-family: var(--font-code);
            font-size: 12px;
            color: var(--c-text-muted);
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* --- BUTTONS --- */
        .btn-primary {
            background: var(--c-primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-primary:hover {
            background: var(--c-primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        .btn-primary:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }

        .btn-secondary {
            background: white;
            border: 1px solid var(--c-border);
            color: var(--c-text-main);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-secondary:hover { background: #f8fafc; border-color: #cbd5e1; }

        /* --- CODE PREVIEW --- */
        .code-window {
            background: #2d2d2d; /* Matches Prism Tomorrow */
            border-radius: 8px;
            border: 1px solid #334155;
            overflow: hidden;
            font-family: var(--font-code);
            font-size: 13px;
            position: relative;
        }
        
        .code-header {
            background: #1e1e1e;
            padding: 8px 16px;
            color: #94a3b8;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #334155;
        }

        pre { margin: 0 !important; padding: 20px !important; height: 350px; overflow: auto; border-radius: 0 !important; }
        
        .warning-banner {
            background: var(--c-warning-bg);
            border-bottom: 1px solid var(--c-warning-border);
            color: var(--c-warning-text);
            padding: 10px 16px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .hidden { display: none !important; }
        
        .loader {
            width: 14px; height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Success Badge */
        .success-badge {
            background: var(--c-success-bg);
            color: var(--c-success-text);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #bbf7d0;
        }
    </style>
</head>
<body>

    <header class="app-header">
        <div class="brand">
            <div class="brand-icon">SQL</div>
            <div>CSV -> SQL</div>
        </div>
        <button onclick="window.location.reload()" class="refresh-btn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.3"/></svg>
            New Project
        </button>
    </header>

    <div class="main-content">
        
        <div id="step1" class="step-card active">
            <div class="step-header">
                <span class="step-badge">Step 1</span>
                <h2 class="step-title">Configuration & Upload</h2>
            </div>

            <div class="config-grid">
                <div class="form-group">
                    <label>Target Database</label>
                    <select id="dialect" class="form-select">
                        <option value="mysql">MySQL / MariaDB</option>
                        <option value="postgres">PostgreSQL</option>
                        <option value="sqlserver">SQL Server (T-SQL)</option>
                        <option value="sqlite">SQLite</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Table Name</label>
                    <input type="text" id="tableName" class="form-input" placeholder="e.g. users_table">
                </div>
                <div class="form-group">
                    <label>Batch Size (Rows)</label>
                    <input type="number" id="batchSize" class="form-input" value="500" min="1" max="5000" title="Rows per INSERT statement">
                </div>
                <div class="form-group">
                    <label>Date Format</label>
                    <select id="dateFormat" class="form-select">
                        <option value="auto">Auto-Detect</option>
                        <option value="us">US (MM/DD/YYYY)</option>
                        <option value="eu">EU (DD/MM/YYYY)</option>
                    </select>
                </div>
                <div class="form-group" style="display:flex; align-items:flex-end;">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer; margin-bottom:12px;">
                        <input type="checkbox" id="addId" checked style="width:16px; height:16px; cursor:pointer;">
                        <span style="font-size:13px; font-weight:500; color:var(--c-text-main); text-transform:none;">Add Primary Key ID</span>
                    </label>
                </div>
            </div>

            <div id="dropZone" class="upload-zone">
                <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                <div class="upload-icon">
                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                </div>
                <div class="upload-text">Click to upload or drag CSV file</div>
                <div class="upload-sub">Secure client-side processing. Data never leaves your device.</div>
            </div>
        </div>

        <div id="step2" class="step-card">
            <div class="step-header" style="justify-content:space-between;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span class="step-badge">Step 2</span>
                    <h2 class="step-title">Schema Mapping</h2>
                </div>
                <button id="generateBtn" onclick="startGeneration()" class="btn-primary">
                    <span id="btnText">Generate Script</span>
                    <div id="btnLoader" class="loader hidden"></div>
                </button>
            </div>

            <div class="mapper-container">
                <table>
                    <thead>
                        <tr>
                            <th style="width: 50px; text-align: center;">
                                <input type="checkbox" id="selectAll" checked onclick="toggleAllColumns()" style="cursor:pointer;" title="Select/Deselect All">
                            </th>
                            <th style="width: 30%;">Column Name</th>
                            <th style="width: 30%;">SQL Type</th>
                            <th>Sample Data</th>
                        </tr>
                    </thead>
                    <tbody id="mapperBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="step3" class="step-card">
            <div class="step-header" style="justify-content:space-between;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span class="step-badge">Step 3</span>
                    <h2 class="step-title">Result</h2>
                    <span id="recordCountBadge" class="success-badge hidden">0 Rows</span>
                </div>
                <div style="display:flex; gap:10px;">
                    <button onclick="copyToClipboard()" class="btn-secondary">Copy Preview</button>
                    <button onclick="downloadSQL()" class="btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                        Download Full SQL
                    </button>
                </div>
            </div>

            <div class="code-window">
                <div class="code-header">
                    <span style="font-weight:600;">SCRIPT PREVIEW</span>
                    <span id="dialectLabel" style="opacity:0.7;">SQL</span>
                </div>
                <div id="previewWarning" class="warning-banner hidden">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                    Note: Showing first 50 lines only. The download file contains all records.
                </div>
                <pre><code id="codeBlock" class="language-sql">-- SQL will appear here...</code></pre>
            </div>
        </div>

    </div>

    <script>
        // --- GLOBAL STATE ---
        let parsedData = [];
        let csvHeaders = [];
        let inferredTypes = {};
        let finalSQLContent = "";

        // --- DOM REFERENCES ---
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('csvFileInput');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');

        // --- UPLOAD HANDLERS ---
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('drag-active'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-active'));
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-active');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
        dropZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => { if (e.target.files.length) handleFile(e.target.files[0]); });

        function handleFile(file) {
            if (!file.name.match(/\.(csv|txt)$/i)) { alert('Please upload a CSV file.'); return; }
            
            // Auto-fill table name if empty
            const tName = document.getElementById('tableName');
            if(!tName.value) tName.value = file.name.replace(/\.[^/.]+$/, "").replace(/[^a-zA-Z0-9_]/g, "_").toLowerCase();

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                preview: 0,
                complete: function(results) {
                    if (results.errors.length > 0 && !results.data.length) {
                        alert("Error parsing CSV: " + results.errors[0].message);
                        return;
                    }
                    parsedData = results.data;
                    csvHeaders = results.meta.fields;
                    inferTypes(parsedData, csvHeaders);
                    renderMapper();
                    activateStep(step2);
                }
            });
        }

        // --- TYPE INFERENCE ---
        function inferTypes(data, headers) {
            headers.forEach(h => {
                let isInt = true, isFloat = true, isDate = true;
                let hasData = false;
                
                // Scan first 100 rows
                for(let i=0; i<Math.min(data.length, 100); i++) {
                    let val = data[i][h];
                    if(!val || val.trim() === "") continue;
                    hasData = true;
                    val = val.trim();

                    if(isNaN(Number(val))) { isInt = false; isFloat = false; }
                    else {
                        if(val.startsWith('0') && val.length > 1 && val !== "0") { isInt = false; isFloat = false; } // Leading zero
                        if(!Number.isInteger(Number(val))) isInt = false;
                    }
                    
                    if(isNaN(Date.parse(val)) || val.length < 8 || !/\d/.test(val)) isDate = false;
                }

                if(!hasData) inferredTypes[h] = 'VARCHAR(255)';
                else if(isInt) inferredTypes[h] = 'INT';
                else if(isFloat) inferredTypes[h] = 'DECIMAL(10,2)';
                else if(isDate) inferredTypes[h] = 'DATE';
                else inferredTypes[h] = parsedData.some(r => (r[h]||'').length > 255) ? 'TEXT' : 'VARCHAR(255)';
            });
        }

        function renderMapper() {
            const tbody = document.getElementById('mapperBody');
            tbody.innerHTML = '';

            csvHeaders.forEach(header => {
                const tr = document.createElement('tr');
                const type = inferredTypes[header];
                const sample = parsedData[0] ? (parsedData[0][header] || '') : '';

                tr.innerHTML = `
                    <td style="text-align:center;">
                        <input type="checkbox" checked class="col-include" data-col="${header}" style="cursor:pointer; width:16px; height:16px;">
                    </td>
                    <td style="font-weight:600; color:var(--c-text-main);">${header}</td>
                    <td>
                        <select class="col-type form-select" style="padding:6px 10px; font-size:12px;">
                            <option value="INT" ${type==='INT'?'selected':''}>INT</option>
                            <option value="VARCHAR(255)" ${type==='VARCHAR(255)'?'selected':''}>VARCHAR(255)</option>
                            <option value="TEXT" ${type==='TEXT'?'selected':''}>TEXT</option>
                            <option value="DECIMAL(10,2)" ${type==='DECIMAL(10,2)'?'selected':''}>DECIMAL</option>
                            <option value="DATE" ${type==='DATE'?'selected':''}>DATE</option>
                            <option value="BOOLEAN" ${type==='BOOLEAN'?'selected':''}>BOOLEAN</option>
                        </select>
                    </td>
                    <td class="preview-cell" title="${sample}">${sample}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function toggleAllColumns() {
            const master = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.col-include');
            checkboxes.forEach(cb => cb.checked = master.checked);
        }

        // --- GENERATION ---
        function startGeneration() {
            const btn = document.getElementById('generateBtn');
            const loader = document.getElementById('btnLoader');
            const text = document.getElementById('btnText');
            
            text.textContent = "Processing...";
            loader.classList.remove('hidden');
            btn.disabled = true;

            setTimeout(() => {
                generateSQL();
                text.textContent = "Generate Script";
                loader.classList.add('hidden');
                btn.disabled = false;
                activateStep(step3);
            }, 50);
        }

        function generateSQL() {
            const dialect = document.getElementById('dialect').value;
            const tableName = document.getElementById('tableName').value || "export_table";
            const addId = document.getElementById('addId').checked;
            const dateFormat = document.getElementById('dateFormat').value;
            const batchSize = parseInt(document.getElementById('batchSize').value) || 500;

            const q = (s) => {
                s = s.trim().replace(/"/g, '""');
                if(dialect === 'mysql') return `\`${s}\``;
                if(dialect === 'sqlserver') return `[${s}]`;
                return `"${s}"`;
            };

            const activeCols = [];
            const typeMap = {};
            
            document.querySelectorAll('#mapperBody tr').forEach(tr => {
                const cb = tr.querySelector('.col-include');
                if(cb.checked) {
                    const colName = cb.getAttribute('data-col');
                    let type = tr.querySelector('.col-type').value;
                    
                    if(dialect === 'postgres' && type === 'INT') type = 'INTEGER';
                    if(dialect === 'sqlserver' && type === 'TEXT') type = 'VARCHAR(MAX)';
                    if(dialect === 'sqlserver' && type === 'BOOLEAN') type = 'BIT';
                    
                    activeCols.push(colName);
                    typeMap[colName] = type;
                }
            });

            if(activeCols.length === 0) { alert("Please select at least one column."); return; }

            // DDL
            let sql = `-- Generated by Converter Studio\n`;
            sql += `-- Dialect: ${dialect.toUpperCase()} | Rows: ${parsedData.length} | Batch: ${batchSize}\n\n`;
            
            if(dialect === 'mysql') sql += `CREATE TABLE IF NOT EXISTS ${q(tableName)} (\n`;
            else if(dialect === 'sqlserver') sql += `IF OBJECT_ID('${tableName}', 'U') IS NULL CREATE TABLE ${q(tableName)} (\n`;
            else sql += `CREATE TABLE IF NOT EXISTS ${q(tableName)} (\n`;

            if(addId) {
                if(dialect === 'mysql') sql += `    ${q('id')} INT AUTO_INCREMENT PRIMARY KEY,\n`;
                else if(dialect === 'postgres') sql += `    ${q('id')} SERIAL PRIMARY KEY,\n`;
                else if(dialect === 'sqlite') sql += `    ${q('id')} INTEGER PRIMARY KEY AUTOINCREMENT,\n`;
                else sql += `    ${q('id')} INT IDENTITY(1,1) PRIMARY KEY,\n`;
            }

            sql += activeCols.map(c => `    ${q(c)} ${typeMap[c]}`).join(',\n');
            sql += `\n);\n\n`;

            // INSERTS
            sql += `-- Batch Insert Data\n`;
            const colsStr = activeCols.map(q).join(', ');
            let chunk = [];
            
            for (let i = 0; i < parsedData.length; i++) {
                const row = parsedData[i];
                const vals = activeCols.map(col => {
                    let val = row[col];
                    const type = typeMap[col];

                    if (val === null || val === undefined || val.trim() === "") return "NULL";
                    val = val.trim().replace(/'/g, "''"); 

                    if((type.includes('INT') || type.includes('DECIMAL')) && !isNaN(val)) return val;
                    
                    if(type.includes('BIT') || type.includes('BOOLEAN')) {
                        const v = val.toLowerCase();
                        return (v === 'true' || v === '1' || v === 'yes') ? '1' : '0';
                    }

                    if(type === 'DATE') {
                        try {
                            if(dateFormat === 'eu' && val.includes('/')) {
                                const parts = val.split(/[\/\-]/);
                                if(parts.length === 3) val = `${parts[2]}-${parts[1]}-${parts[0]}`;
                            }
                            if(!val.match(/^\d{4}-\d{2}-\d{2}/)) {
                                const d = new Date(val);
                                if(!isNaN(d)) val = d.toISOString().split('T')[0];
                            }
                        } catch(e) {}
                    }

                    return `'${val}'`;
                });

                chunk.push(`(${vals.join(', ')})`);

                if (chunk.length >= batchSize || i === parsedData.length - 1) {
                    if (chunk.length > 0) {
                        sql += `INSERT INTO ${q(tableName)} (${colsStr}) VALUES\n${chunk.join(',\n')};\n`;
                        chunk = [];
                    }
                }
            }

            finalSQLContent = sql;
            
            // Preview Logic
            const lines = sql.split('\n');
            const previewLimit = 50;
            const codeBlock = document.getElementById('codeBlock');
            
            if (lines.length > previewLimit) {
                document.getElementById('previewWarning').classList.remove('hidden');
                codeBlock.textContent = lines.slice(0, previewLimit).join('\n') + `\n\n-- ... (${lines.length - previewLimit} more lines in download file)`;
            } else {
                document.getElementById('previewWarning').classList.add('hidden');
                codeBlock.textContent = sql;
            }
            
            const badge = document.getElementById('recordCountBadge');
            badge.textContent = `${parsedData.length} Rows Generated`;
            badge.classList.remove('hidden');
            
            document.getElementById('dialectLabel').textContent = dialect.toUpperCase();
            Prism.highlightElement(codeBlock);
        }

        // --- UTILS ---
        function activateStep(element) {
            element.classList.add('active');
            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function downloadSQL() {
            if(!finalSQLContent) return;
            const blob = new Blob([finalSQLContent], { type: 'text/sql' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = (document.getElementById('tableName').value || "export") + ".sql";
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyToClipboard() {
            if(!finalSQLContent) return;
            const previewText = document.getElementById('codeBlock').textContent;
            navigator.clipboard.writeText(previewText); // Only copy preview to avoid massive clipboard freeze
            alert("Preview copied to clipboard! (Use Download for full file)");
        }
    </script>
</body>
</html>